# Loan Manager – Agents.md (Guide for OpenAI Codex and AI agents)

This document tells AI agents exactly how to work in this repository. It is aligned with `BUSINESS_REQUIREMENTS.md`, which defines the product scope, OpenAPI contract, and platform behavior. Treat `openapi/schema.yml` as the single source of truth for backend and frontend types/clients.

## Code execution environment (Codex-optimized)

- Node.js: 20.x LTS
- Python: 3.11+
- Package managers: npm (frontend), pip (backend). Using Poetry/uv is acceptable if configured via scripts.
- Required tooling (dev):
  - Frontend: `openapi-typescript`, `openapi-fetch`, `eslint`, `prettier`, `tailwindcss`, `react-to-print`
  - Backend: `fastapi`, `uvicorn`, `pydantic`, `pytest`, `httpx` (tests), `ruff`, `black`, `mypy`

## Repository layout (planned)

- `openapi/`
  - `schema.yml` – living API contract used by both BE and FE
- `backend/` (FastAPI)
  - `app/main.py` – FastAPI app factory and router includes
  - `app/routers/` – domain routers: `clients.py`, `loans.py`, `transactions.py`, `charges.py`, `collateral.py`, `inventory.py`, `documents.py`, `reschedule.py`, `reports.py`, `jobs.py`, `webhooks.py`, `auth.py`
  - `app/models/` – pydantic models aligned to OpenAPI schemas
  - `app/services/` – business logic, idempotency handling, RBAC checks
  - `app/storage/` – persistence abstraction (DB later), outbox table for webhooks
  - `tests/` – pytest suites (routers, services, webhooks, jobs)
- `frontend/` (Next.js + TypeScript + Tailwind)
  - `src/app` or `src/pages` – Next.js routes
  - `src/components` – UI components (printable receipts, drawers, forms)
  - `src/lib/api.ts` – typed client using `openapi-fetch`
  - `src/types/api.d.ts` – generated by `openapi-typescript`
  - `src/styles` – Tailwind setup
  - `__tests__` – Jest/RTL tests
- `docs/` – extra docs if needed
- `scripts/` – helper scripts (codegen, checks)

AI agents may create these directories/files when implementing features.

## Source-of-truth workflow (must follow)

1) Update `openapi/schema.yml` first for any API/contract change.
2) Backend must implement exactly that contract (request/response, errors, headers).
3) Frontend must regenerate types and use the generated definitions (never hand-code API types).

### FE type generation and client

```bash
npm i -D openapi-typescript openapi-fetch
openapi-typescript openapi/schema.yml -o frontend/src/types/api.d.ts
```

```ts
// frontend/src/lib/api.ts
import createClient from 'openapi-fetch';
import type { paths } from '@/types/api';

export const api = createClient<paths>({
  baseUrl: process.env.NEXT_PUBLIC_API_BASE_URL + '/v1',
  headers: () => ({
    Authorization: 'Basic ' + btoa(`${localStorage.getItem('u')}:${localStorage.getItem('p')}`),
  }),
});
```

## Coding conventions

### General
- Use explicit, meaningful names; avoid 1–2 character identifiers.
- Prefer typed APIs and generated types over `any` or ad-hoc DTOs.
- Handle edge cases and return early; keep functions small and cohesive.

### Backend (FastAPI)
- Follow PEP8. Use `ruff` for lint, `black` for format, `mypy` for types.
- Pydantic models must mirror OpenAPI schemas (`Error`, `Client`, `LoanAccount`, etc.).
- Authentication: HTTP Basic over TLS; expose `/me` and enforce RBAC roles per `BUSINESS_REQUIREMENTS.md`.
- Idempotency: accept `Idempotency-Key` on state-changing POSTs and dedupe within a 24h window.
- Transactions/actions: return durable `LoanTransaction` with `receiptNumber` where applicable.
- Vehicle inventory: atomic state changes on disbursement (`IN_STOCK → ALLOCATED → SOLD`); return 409 on conflicts.
- Webhooks: deliver signed POSTs with `X-LM-*` headers and HMAC-SHA256 over raw body; implement retry and delivery log.

### Frontend (Next.js + TS + Tailwind)
- Use TypeScript everywhere; rely on `frontend/src/types/api.d.ts` for API types.
- Never hardcode request/response types; import from generated definitions.
- Use `openapi-fetch` client; set `Idempotency-Key` header for state-changing calls.
- Print receipts using `react-to-print` and the `receiptNumber` from the response.
- Keep components small; use hooks; file naming: `PascalCase.tsx` for components.
- Tailwind utility-first styling; only add custom CSS when necessary.

## Tests and local run

### Backend
```bash
# install
python -m venv .venv && source .venv/bin/activate
pip install -r backend/requirements.txt  # or use Poetry/uv if configured

# run
uvicorn app.main:app --app-dir backend --reload

# tests
pytest -q backend/tests
```

### Frontend
```bash
cd frontend
npm install
npm run dev

# tests
npm test
npm test -- --coverage
```

## Lint, type-check, build

```bash
# frontend
npm run lint
npm run type-check
npm run build

# backend (if configured)
ruff check backend
black --check backend
mypy backend
```

## PR guidelines

- Provide a clear description of changes and their impact.
- Reference related requirement IDs from `BUSINESS_REQUIREMENTS.md` (e.g., L-5 receipts, L-11 reschedule) when applicable.
- Ensure all checks pass (lint, type, tests, build) for both BE and FE scopes you modify.
- Include screenshots for UI changes.
- Keep PRs focused on a single concern.

## Agent operating procedure (very important)

When asked to add/modify an API or UI flow:
- Update `openapi/schema.yml` to define or adjust endpoints, parameters, headers, request/response schemas, and examples.
- Implement/adjust FastAPI routers/services to match the contract exactly, including RBAC, idempotency, error schema, and 409 conflict rules.
- Regenerate FE types and use the generated types in data layer and components.
- Add/adjust tests: pytest for routers/services; Jest/RTL for UI and data calls.
- For webhooks, always include `X-LM-Event-ID`, `X-LM-Event-Type`, `X-LM-Timestamp`, `X-LM-Signature` and follow the retry policy.

## Environment variables

- `NEXT_PUBLIC_API_BASE_URL` – base URL for FE client, e.g. `https://api.loanmanager.local`
- Backend config should enforce Basic auth and enable batch-only jobs where appropriate.

## Useful examples

- Reschedule preview/commit must use the two-step flow with `previewVersion` token to avoid drift.
- State-changing UI calls must pass `Idempotency-Key: <uuid>`.

See `BUSINESS_REQUIREMENTS.md` for full OpenAPI 3.1 contract, event schemas, and endpoint details.